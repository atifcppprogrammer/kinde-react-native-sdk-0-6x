var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _jwtDecode=_interopRequireDefault(require("jwt-decode"));var _reactNative=require("react-native");var _urlParse=_interopRequireDefault(require("url-parse"));var _unauthenticated=require("../common/exceptions/unauthenticated.exception");var _unexpected=require("../common/exceptions/unexpected.exception");var _Enums=require("./Enums");var _AuthorizationCode=_interopRequireDefault(require("./OAuth/AuthorizationCode"));var _Storage=require("./Storage");var _Utils=require("./Utils");var KindeSDK=function(){function KindeSDK(issuer,redirectUri,clientId,logoutRedirectUri){var scope=arguments.length>4&&arguments[4]!==undefined?arguments[4]:'openid profile email offline';var additionalParameters=arguments.length>5&&arguments[5]!==undefined?arguments[5]:{};(0,_classCallCheck2["default"])(this,KindeSDK);(0,_defineProperty2["default"])(this,"issuer",void 0);(0,_defineProperty2["default"])(this,"redirectUri",void 0);(0,_defineProperty2["default"])(this,"clientId",void 0);(0,_defineProperty2["default"])(this,"logoutRedirectUri",void 0);(0,_defineProperty2["default"])(this,"scope",void 0);(0,_defineProperty2["default"])(this,"clientSecret",void 0);(0,_defineProperty2["default"])(this,"additionalParameters",void 0);(0,_defineProperty2["default"])(this,"authStatus",void 0);this.issuer=issuer;(0,_Utils.checkNotNull)(this.issuer,'Issuer');this.redirectUri=redirectUri;(0,_Utils.checkNotNull)(this.redirectUri,'Redirect URI');this.clientId=clientId;(0,_Utils.checkNotNull)(this.clientId,'Client Id');this.logoutRedirectUri=logoutRedirectUri;(0,_Utils.checkNotNull)(this.logoutRedirectUri,'Logout Redirect URI');this.additionalParameters=(0,_Utils.checkAdditionalParameters)(additionalParameters);this.scope=scope;this.clientSecret='';this.authStatus=_Enums.AuthStatus.UNAUTHENTICATED;}(0,_createClass2["default"])(KindeSDK,[{key:"login",value:function login(){var additionalParameters=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};(0,_Utils.checkAdditionalParameters)(additionalParameters);this.cleanUp();var auth=new _AuthorizationCode["default"]();this.updateAuthStatus(_Enums.AuthStatus.AUTHENTICATING);var additionalParametersMerged=Object.assign({},this.additionalParameters,additionalParameters);return auth.login(this,true,'login',additionalParametersMerged);}},{key:"getToken",value:function(){var _getToken=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){var url,token,_formData,URLParsed,_URLParsed$query,code,error,error_description,msg,formData,state,codeVerifier,_args=arguments;return _regenerator["default"].wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:url=_args.length>0&&_args[0]!==undefined?_args[0]:'';_context.next=3;return _Storage.sessionStorage.getToken();case 3:token=_context.sent;if(!(token&&!url)){_context.next=15;break;}_context.next=7;return this.isAuthenticated;case 7:if(!_context.sent){_context.next=9;break;}return _context.abrupt("return",token);case 9:_formData=new FormData();_formData.append('client_id',this.clientId);_formData.append('client_secret',this.clientSecret);_formData.append('grant_type','refresh_token');_formData.append('refresh_token',token.refresh_token);return _context.abrupt("return",this.fetchToken(_formData));case 15:if(!this.checkIsUnAuthenticated()){_context.next=17;break;}throw new _unauthenticated.UnAuthenticatedException();case 17:(0,_Utils.checkNotNull)(url,'URL');URLParsed=(0,_urlParse["default"])(url,true);_URLParsed$query=URLParsed.query,code=_URLParsed$query.code,error=_URLParsed$query.error,error_description=_URLParsed$query.error_description;if(!error){_context.next=23;break;}msg=error_description!==null&&error_description!==void 0?error_description:error;throw new _unauthenticated.UnAuthenticatedException(msg);case 23:(0,_Utils.checkNotNull)(code,'code');formData=new FormData();formData.append('code',code);formData.append('client_id',this.clientId);formData.append('client_secret',this.clientSecret);formData.append('grant_type','authorization_code');formData.append('redirect_uri',this.redirectUri);state=_Storage.sessionStorage.getState();if(state){formData.append('state',state);}codeVerifier=_Storage.sessionStorage.getCodeVerifier();if(codeVerifier){formData.append('code_verifier',codeVerifier);}return _context.abrupt("return",this.fetchToken(formData));case 35:case"end":return _context.stop();}},_callee,this);}));function getToken(){return _getToken.apply(this,arguments);}return getToken;}()},{key:"fetchToken",value:function fetchToken(formData){var _this=this;return new Promise(function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(resolve,reject){var response,dataResponse;return _regenerator["default"].wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:_context2.next=2;return fetch(_this.tokenEndpoint,{method:'POST',headers:{'Content-Type':'multipart/form-data'},body:formData});case 2:response=_context2.sent;_context2.next=5;return response.json();case 5:dataResponse=_context2.sent;if(!dataResponse.error){_context2.next=9;break;}reject(dataResponse);return _context2.abrupt("return");case 9:_context2.next=11;return _Storage.sessionStorage.setToken(dataResponse);case 11:_this.updateAuthStatus(_Enums.AuthStatus.AUTHENTICATED);resolve(dataResponse);case 13:case"end":return _context2.stop();}},_callee2);}));return function(_x,_x2){return _ref.apply(this,arguments);};}());}},{key:"register",value:function register(){var additionalParameters=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};(0,_Utils.checkAdditionalParameters)(additionalParameters);var auth=new _AuthorizationCode["default"]();this.updateAuthStatus(_Enums.AuthStatus.AUTHENTICATING);return auth.login(this,true,'registration',additionalParameters);}},{key:"createOrg",value:function createOrg(){var additionalParameters=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return this.register(Object.assign({is_create_org:true},additionalParameters));}},{key:"logout",value:function(){var _logout=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(){var URLParsed;return _regenerator["default"].wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.cleanUp();case 2:URLParsed=(0,_urlParse["default"])(this.logoutEndpoint,true);URLParsed.query['redirect']=this.logoutRedirectUri;return _context3.abrupt("return",_reactNative.Linking.openURL(URLParsed.toString()));case 5:case"end":return _context3.stop();}},_callee3,this);}));function logout(){return _logout.apply(this,arguments);}return logout;}()},{key:"cleanUp",value:function(){var _cleanUp=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(){return _regenerator["default"].wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:this.updateAuthStatus(_Enums.AuthStatus.UNAUTHENTICATED);return _context4.abrupt("return",_Storage.sessionStorage.clearAll());case 2:case"end":return _context4.stop();}},_callee4,this);}));function cleanUp(){return _cleanUp.apply(this,arguments);}return cleanUp;}()},{key:"updateAuthStatus",value:function updateAuthStatus(_authStatus){this.authStatus=_authStatus;_Storage.sessionStorage.setAuthStatus(this.authStatus);}},{key:"checkIsUnAuthenticated",value:function checkIsUnAuthenticated(){var authStatusStorage=_Storage.sessionStorage.getAuthStatus();if((!this.authStatus||this.authStatus===_Enums.AuthStatus.UNAUTHENTICATED)&&(!authStatusStorage||authStatusStorage===_Enums.AuthStatus.UNAUTHENTICATED)){return true;}return false;}},{key:"getUserDetails",value:function(){var _getUserDetails=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee5(){return _regenerator["default"].wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:return _context5.abrupt("return",_Storage.sessionStorage.getUserProfile());case 1:case"end":return _context5.stop();}},_callee5);}));function getUserDetails(){return _getUserDetails.apply(this,arguments);}return getUserDetails;}()},{key:"getClaims",value:function(){var _getClaims=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee6(){var tokenType,token,_args6=arguments;return _regenerator["default"].wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:tokenType=_args6.length>0&&_args6[0]!==undefined?_args6[0]:_Enums.TokenType.ACCESS_TOKEN;if([_Enums.TokenType.ACCESS_TOKEN,_Enums.TokenType.ID_TOKEN].includes(tokenType)){_context6.next=3;break;}throw new _unexpected.UnexpectedException('tokenType');case 3:_context6.next=5;return _Storage.sessionStorage.getTokenType(tokenType);case 5:token=_context6.sent;if(token){_context6.next=8;break;}throw new _unauthenticated.UnAuthenticatedException();case 8:return _context6.abrupt("return",(0,_jwtDecode["default"])(token));case 9:case"end":return _context6.stop();}},_callee6);}));function getClaims(){return _getClaims.apply(this,arguments);}return getClaims;}()},{key:"getClaim",value:function(){var _getClaim=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee7(keyName){var tokenType,claims,_args7=arguments;return _regenerator["default"].wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:tokenType=_args7.length>1&&_args7[1]!==undefined?_args7[1]:_Enums.TokenType.ACCESS_TOKEN;_context7.next=3;return this.getClaims(tokenType);case 3:claims=_context7.sent;return _context7.abrupt("return",claims[keyName]);case 5:case"end":return _context7.stop();}},_callee7,this);}));function getClaim(_x3){return _getClaim.apply(this,arguments);}return getClaim;}()},{key:"getPermissions",value:function(){var _getPermissions=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee8(){var claims;return _regenerator["default"].wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:_context8.next=2;return this.getClaims();case 2:claims=_context8.sent;return _context8.abrupt("return",{orgCode:claims['org_code'],permissions:claims['permissions']});case 4:case"end":return _context8.stop();}},_callee8,this);}));function getPermissions(){return _getPermissions.apply(this,arguments);}return getPermissions;}()},{key:"getPermission",value:function(){var _getPermission=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee9(permission){var allClaims,permissions;return _regenerator["default"].wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:_context9.next=2;return this.getClaims();case 2:allClaims=_context9.sent;permissions=allClaims['permissions'];return _context9.abrupt("return",{orgCode:allClaims['org_code'],isGranted:permissions===null||permissions===void 0?void 0:permissions.includes(permission)});case 5:case"end":return _context9.stop();}},_callee9,this);}));function getPermission(_x4){return _getPermission.apply(this,arguments);}return getPermission;}()},{key:"getOrganization",value:function(){var _getOrganization=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee10(){var orgCode;return _regenerator["default"].wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:_context10.next=2;return this.getClaim('org_code');case 2:orgCode=_context10.sent;return _context10.abrupt("return",{orgCode:orgCode});case 4:case"end":return _context10.stop();}},_callee10,this);}));function getOrganization(){return _getOrganization.apply(this,arguments);}return getOrganization;}()},{key:"getUserOrganizations",value:function(){var _getUserOrganizations=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee11(){var orgCodes;return _regenerator["default"].wrap(function _callee11$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:_context11.next=2;return this.getClaim('org_codes',_Enums.TokenType.ID_TOKEN);case 2:orgCodes=_context11.sent;return _context11.abrupt("return",{orgCodes:orgCodes});case 4:case"end":return _context11.stop();}},_callee11,this);}));function getUserOrganizations(){return _getUserOrganizations.apply(this,arguments);}return getUserOrganizations;}()},{key:"isAuthenticated",get:function get(){return(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee12(){var timeExpired,now;return _regenerator["default"].wrap(function _callee12$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:_context12.next=2;return _Storage.sessionStorage.getExpiredAt();case 2:timeExpired=_context12.sent;now=new Date().getTime();return _context12.abrupt("return",timeExpired*1000>now);case 5:case"end":return _context12.stop();}},_callee12);}))();}},{key:"authorizationEndpoint",get:function get(){return this.issuer+"/oauth2/auth";}},{key:"tokenEndpoint",get:function get(){return this.issuer+"/oauth2/token";}},{key:"logoutEndpoint",get:function get(){return this.issuer+"/logout";}}]);return KindeSDK;}();var _default=KindeSDK;exports["default"]=_default;